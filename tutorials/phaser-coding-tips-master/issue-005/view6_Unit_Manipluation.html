<!DOCTYPE html>
<html>
	<head>
		<title>Unit Manipulation</title>
		<script type="text/javascript" src="resource/js/jquery-3.1.0.min.js"></script>
		<script type="text/javascript" src="resource/js/phaser.min.js"></script>
		<script type="text/javascript" src="resource/js/randomColor.js"></script>
	</head>

	<body>
		<div id="viewport"></div>
		<div id="setting_holder">
			<button onclick="addVehicle()">ADD</button>

			<form id="config" onSubmit="changeConfig(); return false;">
				<input name="veh_name" type="text" />
				<input name="pos_x" type="number" />
				<input name="pos_y" type="number" />
				<input name="vel" type="number" min="0" max="150" />
				<input name="angle" type="number" />
				<input type="submit" val="Change" />
			</form>
		</div>
	</body>

	<script>
	function randomColorToHex(options) {
		var code = randomColor(options);

		if(code.constructor == Array) {
			var temp = [];
			for(i in code) {
				temp.push(parseInt('0x' + code[i].substring(1), 16));
			}
			return temp;
		} else {
			return parseInt('0x' + code.substring(1), 16)
		}
	}
	</script>

	<script>
	var screen_width = 500;
	var screen_height = 600;
	var vehicle_num = 0;
	var vehicle_list = [];
	var selected_vehicle = {};
	var form = 	$('form#config');

	var game = new Phaser.Game(screen_width, screen_height, Phaser.AUTO, 'viewport', {
		preload: preload,
		create: create,
		update: update
	});

	function preload() {
		var assetFolderDir = 'resource/assets/';
		game.load.image('star', assetFolderDir + 'star.png');
		game.load.image('car', assetFolderDir + 'car90.png');
	}

	function create() {
		game.stage.backgroundColor = randomColor();

		game.input.mouse.mouseWheelCallback = mouseWheel;
		game.input.mouse.mouseDownCallback = mouseDown;
	}

	function update() {

	}
	</script>

	<script>
	function mouseDown(event) {
		var target_object = game.input.activePointer.targetObject;

		if(target_object == null) {
			if(selected_vehicle.sprite != null) {
				selected_vehicle.sprite.tint = 0xffffff;
				selected_vehicle = {};
				form.trigger('reset');
			}
		} else {
			if (selected_vehicle.sprite == null) {
				selectVehicle(target_object.sprite);

			} else if(target_object.sprite != selected_vehicle.sprite) {
				selected_vehicle.sprite.tint = 0xffffff;
				selectVehicle(target_object.sprite);
			}
		}
	}

	function mouseWheel(event) {
		if(selected_vehicle.sprite != null) {
			selected_vehicle.sprite.angle += game.input.mouse.wheelDelta * 5;
			form.find('[name=angle]').val(convertToDegree(selected_vehicle.sprite.rotation));
		}
	}

	function updateVehiclePos(sprite) {
		form.find('[name=pos_x]').val(sprite.x);
		form.find('[name=pos_y]').val(sprite.y);
	}	

	function selectVehicle(sprite) {
		sprite.tint = 0x99ff99;

		selected_vehicle = findVehicle(sprite);

		form.find('[name=veh_name]').val(selected_vehicle.name);
		form.find('[name=vel]').val(selected_vehicle.vel);
		form.find('[name=angle]').val(convertToDegree(selected_vehicle.sprite.rotation));
	}
	</script>

	<script>
	function normalizeDegree(angleDeg) {
		var mod_angle = angleDeg % 360;
		if(mod_angle > 180) {
			mod_angle = mod_angle - 360;
		} else if (mod_angle <= -180) {
			mod_angle = mod_angle + 360;
		}

		return mod_angle;
	}

	function normalizeRadian(angleRad) {
		var mod_angle = angleRad % (Math.PI * 2);
		if(mod_angle > Math.PI) {
			mod_angle = mod_angle - (Math.PI * 2);
		} else if (mod_angle <= -Math.PI) {
			mod_angle = mod_angle + (Math.PI * 2);
		}

		return mod_angle;
	}

	function convertToRadian(angleDeg) {
		var norm_deg = normalizeDegree(angleDeg);
		return norm_deg * Math.PI / 180;
	}

	function convertToDegree(angleRad) {
		var norm_rad = normalizeRadian(angleRad);
		return norm_rad * 180 / Math.PI;
	}
	</script>

	<script>
	function addVehicle() {
		var added = {};

		var added_sprite = game.add.sprite(game.world.centerX, game.world.centerY, 'car');
		added_sprite.name = 'Car ' + vehicle_num;
		vehicle_num ++;
		added_sprite.anchor.setTo(0.5, 0.5);
		added_sprite.angle = -90;

		added_sprite.inputEnabled = true;
		added_sprite.input.enableDrag(true);
		added_sprite.input.enableSnap(16, 16, false, true);
		
		added_sprite.events.onDragUpdate.add(updateVehiclePos, this);
		
		added.sprite = added_sprite;

		added.vel = 0;
		added.name = added_sprite.name;

		vehicle_list.push(added);
	}

	function findVehicle(sprite) {
		var found = $.grep(vehicle_list, function(e) {
			return e.name == sprite.name;
		});

		if(found.length == 0) {
			return null;
		} else {
			return found[0];
		}
	}

	function changeConfig() {
		var name = form.find('[name=veh_name]').val();
		var x = parseInt(form.find('[name=pos_x]').val());
		var y = parseInt(form.find('[name=pos_y]').val());
		var vel = parseInt(form.find('[name=vel]').val());
		var angle = parseInt(form.find('[name=angle]').val());
		var rot = convertToRadian(angle);

		selected_vehicle.sprite.name = name;
		selected_vehicle.sprite.x = x;
		selected_vehicle.sprite.y = y;
		selected_vehicle.sprite.rotation = rot;

		selected_vehicle.name = name;
		selected_vehicle.vel = vel;

		return true;
	}
	</script>
</html>
