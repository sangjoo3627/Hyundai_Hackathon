<!DOCTYPE html>
<html>
	<head>
		<title>Unit Manipulation</title>
		<script type="text/javascript" src="resource/js/jquery-3.1.0.min.js"></script>
		<script type="text/javascript" src="resource/js/phaser.min.js"></script>
		
		<script type="text/javascript" src="resource/js/clusteringNode.js"></script>
		<script type="text/javascript" src="resource/js/drivingDangerDetectNode.js"></script>
		
		<script type="text/javascript" src="resource/js/util.js"></script>
	</head>

	<body>
		<div id="viewport"></div>
		<div id="setting_holder">
			<button onclick="addVehicle()">ADD</button>
			<button onclick="deleteVehicle()">DELETE</button>
			<button onclick="startInterval()">START</button>
			<button onclick="endInterval()">END</button>
			
			
			<form id="config">
				<input name="veh_name" type="text" />
				<input name="pos_x" type="number" />
				<input name="pos_y" type="number" />
				<input name="vel" type="number" min="0" max="150" />
				<input name="angle" type="number" />
				<input type="button" value="change" onclick="changeVehicleProperty()" />
			</form>
		</div>
	</body>
	
	<script>
		/*
		 *	Phaser Game Initialization
		 */ 
		var screen_width = 500;
		var screen_height = 600;
		var vehicle_num = 0;
		var vehicle_list = [];
		var cluster_list = [];
		
		var selected_vehicle = {};
		var detect_arc;
		var cluster_area;
		var form = 	$('form#config');
		
		
		var game = new Phaser.Game(screen_width, screen_height, Phaser.AUTO, 'viewport', {
			preload: preload,
			create: create,
			update: update,
			render: render
		});
		
		function preload() {
			var assetFolderDir = 'resource/assets/';
			game.load.image('star', assetFolderDir + 'star.png');
			game.load.image('car', assetFolderDir + 'car90.png');
		}

		function create() {
			game.stage.backgroundColor = '#99FF00';

			game.input.mouse.mouseWheelCallback = mouseWheel;
			game.input.mouse.mouseDownCallback = mouseDown;
			
			detect_arc = game.add.graphics(0, 0);
			cluster_area = game.add.graphics(0, 0);
		}

		function update() {
			
		}
		
		function render() {
			updateDetectArc();
			updateClusterArea();
		}
	</script>
	
	<script>
		/*
		 *	Worker & Intervals
		 */
		var clusteringNode = new ClusteringNode();;
		var drivingDangerDetectNode = new DrivingDangerDetectNode();
		
		drivingDangerDetectNode.transfer = function(victim_cluster, killer_cluster, degree) {
			window.dispatchEvent(new CustomEvent('driving_'+degree, {
				victim_cluster: victim_cluster, killer_cluster: killer_cluster
			}));
		}
		
		var interval = null;
		
		function startInterval() {
			if(interval == null) {					
				interval = setInterval(function(){
					console.log('Interval');
					clusteringNode.setVehicleList(vehicle_list);
					clusteringNode.cluster();
					cluster_list = clusteringNode.getClusterList();
					vehicle_list = clusteringNode.getVehicleList();
					
					console.log('drivingDangerDetectNode');
					drivingDangerDetectNode.setClusterList(cluster_list);
					drivingDangerDetectNode.detect();
				}, 3000);
			}
		}
		
		function endInterval() {
			clearInterval(interval);
		}
	</script>
	
	<script>
		window.addEventListener('driving_caution', function(e){
			console.log('driving_caution');
		});
		
		window.addEventListener('driving_danger', function(e){
			console.log('driving_danger');
		});
	</script>
	
	<script>
		/*
		 * Phaser Mouse Event Handler
		 */
		function mouseDown(event) {
			var target_object = game.input.activePointer.targetObject;

			if(target_object == null) {
				if(selected_vehicle.sprite != null) {
					selected_vehicle.sprite.tint = 0xffffff;
					selected_vehicle = {};
					resetConfig();
				}
			} else {
				if (selected_vehicle.sprite == null) {
					selectVehicle(target_object.sprite);

				} else if(target_object.sprite != selected_vehicle.sprite) {
					selected_vehicle.sprite.tint = 0xffffff;
					selectVehicle(target_object.sprite);
				}
			}
		}

		function mouseWheel(event) {
			if(selected_vehicle.sprite != null) {
				selected_vehicle.sprite.angle += game.input.mouse.wheelDelta * 5;
				
				setConfig({
					angle: convertToDegree(selected_vehicle.sprite.rotation)
				});
			}
		}

		function updateVehiclePos(sprite) {
			setConfig({
				pos_x: sprite.x,
				pos_y: sprite.y
			});
		}	

		function selectVehicle(sprite) {
			sprite.tint = 0x99ff99;

			selected_vehicle = findVehicle(sprite);

			setConfig({
				veh_name: selected_vehicle.name,
				vel: selected_vehicle.vel,
				angle: convertToDegree(selected_vehicle.sprite.rotation)
			});
		}
		
		function findVehicle(sprite) {
			var found = $.grep(vehicle_list, function(e) {
				return e.name == sprite.name;
			});

			if(found.length == 0) {
				return null;
			} else {
				return found[0];
			}
		}
		
		function updateDetectArc() {
			detect_arc.clear();
			
			if(selected_vehicle.sprite != null) {
				vehicle = selected_vehicle;
				sprite = vehicle.sprite;
				
				detect_arc.lineStyle(1, 0xffffff);
				detect_arc.beginFill(0xCC0000, 0.9);
				detect_arc.arc(sprite.x, sprite.y,
					clusteringNode._getDetectDst(vehicle.vel),
					sprite.rotation + clusteringNode._getAngleTole(vehicle.vel),
					sprite.rotation - clusteringNode._getAngleTole(vehicle.vel),
					true
				);
				detect_arc.arc(sprite.x, sprite.y,
					clusteringNode._getDetectDst(vehicle.vel),
					game.math.reverseAngle(sprite.rotation) + clusteringNode._getAngleTole(vehicle.vel),
					game.math.reverseAngle(sprite.rotation) - clusteringNode._getAngleTole(vehicle.vel),
					true
				);
				detect_arc.endFill();
			}			
		}
		
		function updateClusterArea() {
			cluster_area.clear();
			
			if(selected_vehicle.sprite != null && selected_vehicle.cluster != -1) {
				var vehicle_list = cluster_list[selected_vehicle.cluster].vehicle_list;
				
				cluster_area.lineStyle(1, 0xffffff);
				cluster_area.beginFill(0xFFCC00, 0.7);
				
				for(i in vehicle_list) {
					var sprite = vehicle_list[i].sprite;
					cluster_area.drawCircle(sprite.x, sprite.y, 30);
				}
				
				cluster_area.endFill();				
			}
		}
	</script>

	<script>
		/*
		 * Configuration getter setter
		 */		
		function getConfig() {
			var veh_name = form.find('[name=veh_name]').val();
			var pos_x = form.find('[name=pos_x]').val();
			var pos_y = form.find('[name=pos_y]').val();
			var vel = form.find('[name=vel]').val();
			var angle = form.find('[name=angle]').val();
		
			return {
				veh_name: veh_name,
				pos_x: pos_x,
				pos_y: pos_y,
				vel: vel,
				angle: angle
			};
		}
		
		function setConfig(new_config) {
			if(new_config.veh_name != null)
				form.find('[name=veh_name]').val(new_config.veh_name);
			if(new_config.pos_x != null)
				form.find('[name=pos_x]').val(new_config.pos_x);
			if(new_config.pos_y != null)
				form.find('[name=pos_y]').val(new_config.pos_y);
			if(new_config.vel != null)
				form.find('[name=vel]').val(new_config.vel);
			if(new_config.angle != null)
				form.find('[name=angle]').val(new_config.angle);
			
		}
		
		function resetConfig() {
			form.trigger('reset');
		}
	</script>
	
	<script>
		/*
		 * Add Vehicle
		 */
		function addVehicle() {
			var added = {};

			var added_sprite = game.add.sprite(game.world.centerX, game.world.centerY, 'car');
			added_sprite.name = 'Car ' + vehicle_num;
			vehicle_num ++;
			added_sprite.anchor.setTo(0.5, 0.5);
			added_sprite.angle = -90;

			added_sprite.inputEnabled = true;
			added_sprite.input.enableDrag(true);
			// added_sprite.input.enableSnap(16, 16, false, true);
			
			added_sprite.events.onDragUpdate.add(updateVehiclePos, this);
			
			added.sprite = added_sprite;

			added.vel = 0;
			added.name = added_sprite.name;
			added.cluster = -1;

			vehicle_list.push(added);
		}
	</script>
	
	<script>
		/*
		 * Delete Vehicle
		 */
		function deleteVehicle() {	
			var deleted_sprite = selected_vehicle.sprite;
			
			if(deleted_sprite == null) {
				console.log('Nothing Selected');
				return;
			}
			
			for(i in vehicle_list) {
				if(vehicle_list[i] == selected_vehicle) {
					vehicle_list.splice(i, 1);
				}
			}
			
			deleted_sprite.destroy();
			selected_vehicle = {};
			resetConfig();
		}
	</script>
	
	<script>
		/*
		 * Form Submit Change Vehicle Property
		 */
		function changeVehicleProperty() {
			var config = getConfig();
			
			var name = config.veh_name;
			var x = parseInt(config.pos_x);
			var y = parseInt(config.pos_y);
			var vel = parseInt(config.vel);
			var angle = parseInt(config.angle);
			var rot = convertToRadian(angle);

			selected_vehicle.sprite.name = name;
			selected_vehicle.sprite.x = x;
			selected_vehicle.sprite.y = y;
			selected_vehicle.sprite.rotation = rot;

			selected_vehicle.name = name;
			selected_vehicle.vel = vel;
		}
	</script>
</html>
